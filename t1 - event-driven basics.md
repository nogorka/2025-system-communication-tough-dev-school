**Ссылка на Event Storming:** https://app.holst.so/share/b/b19b104e-d2c0-48a9-9f6b-05ac10b39322

Там внутри две схемы друг под другом (для удобства): 
- просто события по порядку
- события в контексте сервисов

**Сокращения сервисов** (из таблиц)
- Управление и создание заданий - З
- Найм учителей - Н
- Расчет бонусов менеджерам - Б

| Номер связи            | Название связи                                                          | Как связь сделана на текущий момент                               | Какая теперь будет связь                                                                                                                               | Номера проблем бизнеса, которые потенциально решаются                                                             | Почему связь необходимо изменить                                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------------------- | ----------------------------------------------------------------------- | ----------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| [COMM-010]             | Получение информации о менеджере                                        | Н -> З: HTTP-вызов                                                | Можно не менять, это обычный GET REST                                                                                                                  |                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [COMM-020]             | Получение информации о задании                                          | Н -> З: HTTP-вызов                                                | Можно не менять, это обычный GET REST                                                                                                                  |                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [COMM-030]             | Назначение менеджера на переделку задания                               | Н -> З: HTTP-вызов                                                | Асинхронное событие `TaskRequires Complication`<br>в kafka                                                                                             | [Problem-050],<br>[Problem-020]                                                                                   | Переход на асинхронное событие понизит связноость, больше не будет блокировки и процесс проверки [US-080] и обновления [US-030] пойдет быстрее + не будет каскада ошибок                                                                                                                                                                                                                                                                   |
| [COMM-040]             | Зачисление бонусов на счёт менеджера                                    | Н -> Б: HTTP-вызов                                                | Асинхронное событие `BonusAdded`<br>в kafka                                                                                                            | [Problem-010],<br>[Problem-020],[Problem-030],<br>[Problem-050],[Problem-070],<br>[Problem-080],<br>[Problem-100] | Синхронный вызов может блокировать процесс проверки [US-080], создают каскад ошибок который вылазит там где не надо, операции дублируются или теряются данные                                                                                                                                                                                                                                                                              |
| [COMM-050]             | Списание средств со счёта менеджера                                     | Н -> Б: HTTP-вызов                                                | Асинхронное событие `FineAdded`<br>в kafka                                                                                                             | [Problem-010],<br>[Problem-020],[Problem-030],<br>[Problem-050],[Problem-070],<br>[Problem-080],<br>[Problem-100] | То же самое что и в [COMM-040]<br><br>Синхронный вызов может блокировать процесс проверки [US-080], создают каскад ошибок который вылазит там где не надо, операции дублируются или теряются данные                                                                                                                                                                                                                                        |
| [COMM-060]             | Отправка события `TaskRating`                                           | Н -> Б:<br>Асинхронная отправка события через kafka, топик `task` | Асинхронное событие kafka `TaskRatingChanged`                                                                                                          | [Problem-030], [Problem-100]                                                                                      | Тут как будто сильно не поменяешь ничего, только переименовать событие                                                                                                                                                                                                                                                                                                                                                                     |
| [COMM-070]             | Получение информации о менеджере                                        | Б -> З: HTTP-вызов                                                | Можно не менять, это обычный GET REST                                                                                                                  |                                                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [COMM-080]             | Зачисление средств на счёт менеджера                                    | З -> Б: HTTP-вызов                                                | Асинхронное событие kafka `PaymentCommited`                                                                                                            | [Problem-040]?                                                                                                    | Избавляемся от каскада ошибок                                                                                                                                                                                                                                                                                                                                                                                                              |
| **UPDATED** [COMM-090] | Получение списка кандидатов в учителя, которым будут назначаться задачи | Н -> З: HTTP-вызов                                                | **Вариант 1:** Можно не менять, это обычный GET REST<br><br>**Вариант 2:** Можно сделать через ассинхронное событие kafka <br>`NewCandidateRegistered` | [Problem-060], [Problem-040]?                                                                                     | **Вариант 1:** Потенциально может быть проблема,  когда менеджер много раз заходит для назначения. И тут можно было бы сделать батчевое назначение или хотябы банчевое уведомление. Но мы ничего не знаем о потоке регистраций, поэтому предполагаем что это не высокая нагрузка и оно не крашит систему<br><br>**Вариант 2:** Если это все таки поток, то нужно добавить событие чтобы разгрузить нагрузку для сервиса найма учителей (Н) |


### Вспомогательная таблица: Проблемы, коментарии, гипотезы

| Номер проблемы | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                 | Потенциальные связи                                                              | Комментарий                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [Problem-010]  | Долго определяется правильность выполнения задания от кандидата. Это вызывает задержки, которые бесят менеджеров и учителей.                                                                                                                                                                                                                                                                                                             | [COMM-090], [COMM-060],<br>[COMM-050], [COMM-040],<br>[COMM-030]                 | Тут возможно синхронные вызовы тормозят процесс проверки. Возможно внутри проверки также заложена фин. логика + назначение менеджеров для переделки                                                                                                                                                                                                                                                                                               |
| [Problem-020]  | Кандидаты в учителя читерят систему в месте, где простое задание должно усложниться, но этого ещё не произошло. Для этого они собираются в группы, где делятся лёгкими заданиями между собой, и, пока задание обновляется, пачкой выполняют лёгкие версии.<br><br>**UPDATED**: [Problem-020] Главная проблема тут в том, что нужно как можно быстрее менять задание для кандидатов в учителя, после того, как менеджер поправит задание. | [COMM-030], [COMM-040],<br>[COMM-050],<br>[COMM-060]                             | - Задание не обновляется мгновенно после редактирования?<br><br>- Но тут еще надо делать скидку на неавтоматизированный ручной труд менеджера<br><br>- А возможно именно из-за долгих фин. операций для автора задачи, при условии >10 в процессе назначения происходит торможение. Типа считаем вместе деньги и обновления, и деньги не дают назначить ответстенного за обновления<br><br>+ Задержка объявления актуального рейтинга тоже влияет |
| [Problem-030]  | Логика начисления бонусов некорректна из-за ошибки с рейтингом задания. Во время начисления бонусов во время изменения рейтинга, происходит задержка, которая не удовлетворяет бизнес (нужно моментально).                                                                                                                                                                                                                               | [COMM-040],<br>[COMM-050],<br>[COMM-060]                                         | Асинхронное событие с задержкой? такое бывает?                                                                                                                                                                                                                                                                                                                                                                                                    |
| [Problem-040]  | Медленно начисляются бонусы менеджерам, потому что много кандидатов в учителя. Иногда вся система падает и не восстанавливается.                                                                                                                                                                                                                                                                                                         |                                                                                  | Блокировки из-за перегрузки? bottleneck?                                                                                                                                                                                                                                                                                                                                                                                                          |
| [Problem-050]  | В UI может отобразиться ошибка каких-то запросов после успешного выполнения задания. Разработчики объясняют это поведение вызовом сервиса оплаты и создания заданий.                                                                                                                                                                                                                                                                     | [COMM-030], [COMM-040],<br>[COMM-050],                                           | - Излишняя связность?<br><br>- Тут явно приходит ошибки из процессов начислений или усложнений задачи и отображаются как результат работы именно оценки                                                                                                                                                                                                                                                                                           |
| [Problem-060]  | Нужно сократить расходы на скейлинг сервиса заданий. Сейчас дорого.                                                                                                                                                                                                                                                                                                                                                                      |                                                                                  | Много запросов??? Непонятно...                                                                                                                                                                                                                                                                                                                                                                                                                    |
| [Problem-070]  | Менеджерам иногда начисляются бонусы дважды. Это связано с тем, что, когда кандидаты в учителя отправляют то же самое задание повторно, система тупит [Problem-050]. Разработчики объясняют тем, что управление заданиями падает, а бонусами — нет. Из-за этого бонусы попадают в два одинаковых запроса.                                                                                                                                | [COMM-040],<br>[COMM-050],                                                       | - Как возможно задание отправить дважды? Через UI?<br><br>- Мб где-то хранить результаты проверки чтобы отдавать если что?<br><br>- В процессе проверки должно быть событие с id задачи и оценкой, при повторной отправке событие может отправиться второй раз в лог но мы же может посмотреть что это два одинаковых события и не реагировать на второе?                                                                                         |
| [Problem-080]  | Упавший сервис создания заданий или бонусов кладёт всю систему, и учителя не могут выполнять задания.<br>                                                                                                                                                                                                                                                                                                                                | [COMM-090], [COMM-060],<br>[COMM-050], [COMM-040],<br>[COMM-030],<br>[COMM-020], | - Большая связность, из 9 связей 7 идут к сервису найма<br><br>- По идее тут критично только связь [COMM-020] для работы учителей все остальное можно отдать в фон и на ассинхронные события                                                                                                                                                                                                                                                      |
| [Problem-090]  | Фичи выходят слишком медленно. Это связано с тем, что для выполнения любой фичи нужно изучить всю систему и проверить, что ничего не упало. Короче, разработчики сами не понимают, как работает система вне отдельного сервиса.                                                                                                                                                                                                          |                                                                                  | Тут пока непонятно как переход от синхронной коммуникации на ассинхронную может помочь. Тип коммуникации не влияет на наполнение данными. Как я понимаю оно ломается из-за несоответствия моделям данных или какой-нибудь варидации или уже в рантайме все падает с ошибкой - но суть как будто бы одна и та же. Кажется это надо решать через покрытие тестами - я кажется ничего не понимаю                                                     |
| [Problem-100]  | Данные теряются вокруг логики выполнения заданий кандидатами в учителя.                                                                                                                                                                                                                                                                                                                                                                  | [COMM-060],<br>[COMM-050], [COMM-040]                                            | Сбои в синхронных связях?                                                                                                                                                                                                                                                                                                                                                                                                                         |
